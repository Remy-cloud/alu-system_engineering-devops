#!/usr/bin/env bash
# Configure a new Nginx server on macOS, with /redirect_me redirecting to another page.

# Install Nginx using brew
brew install nginx

# Allow Nginx through the firewall (skip this step on macOS if not needed)
# sudo ufw allow 'Nginx HTTP' # Skip for macOS

# Set up the root directory and permissions (macOS doesn't use /var/www)
mkdir -p /usr/local/var/www/html
sudo chmod -R 755 /usr/local/var/www

# Create the default index.html
echo 'Hello World!' > /usr/local/var/www/html/index.html

# Define the Nginx configuration to set up redirection
SERVER_CONFIG="server {
    listen 8080 default_server;
    listen [::]:8080 default_server;
    root /usr/local/var/www/html;
    index index.html index.htm;

    server_name _;

    location / {
        try_files \$uri \$uri/ =404;
    }

    # Redirection for /redirect_me to YouTube with a 301 Moved Permanently
    location /redirect_me {
        return 301 https://www.youtube.com/watch?v=dQw4w9WgXcQ;
    }
}"

# Write the configuration to the default server block
echo -e "$SERVER_CONFIG" > /usr/local/etc/nginx/nginx.conf

# Test Nginx configuration for syntax errors
sudo nginx -t

# If the config is correct, restart Nginx to apply the changes
if [ $? -eq 0 ]; then
  # Restart Nginx to apply the configuration changes
  sudo nginx -s reload
else
  echo "Nginx configuration test failed!"
  exit 1
fi
